(window.webpackJsonp=window.webpackJsonp||[]).push([[218],{680:function(s,t,a){"use strict";a.r(t);var e=a(40),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#介绍"}},[s._v("#")]),s._v(" 介绍")]),s._v(" "),a("p",[s._v("该文章介绍前端静态资源部署的问题，暂不讨论"),a("strong",[s._v("强缓存")]),s._v("与"),a("strong",[s._v("协商缓存")]),s._v("等知识点。")]),s._v(" "),a("h2",{attrs:{id:"静态资源部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#静态资源部署"}},[s._v("#")]),s._v(" 静态资源部署")]),s._v(" "),a("h3",{attrs:{id:"上传前端项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#上传前端项目"}},[s._v("#")]),s._v(" 上传前端项目")]),s._v(" "),a("ol",[a("li",[s._v("在前端服务器上，执行"),a("code",[s._v("cd /")]),s._v("进入到根目录。前端项目我通常会放在自己建立的"),a("code",[s._v("/data/web/")]),s._v("这个目录下。所以先利用"),a("code",[s._v("mkdir")]),s._v("命令创建"),a("code",[s._v("data")]),s._v("目录，然后"),a("code",[s._v("cd data")]),s._v("进入"),a("code",[s._v("data")]),s._v("目录后，再创建"),a("code",[s._v("web")]),s._v("目录并"),a("code",[s._v("cd web")]),s._v("。")]),s._v(" "),a("li",[s._v("我的项目名是"),a("code",[s._v("demo")]),s._v("。所以在"),a("code",[s._v("web")]),s._v("目录下新建一个"),a("code",[s._v("demo")]),s._v("目录。这个"),a("code",[s._v("demo")]),s._v("就可以上传压缩的前端项目"),a("code",[s._v("dist")]),s._v("包。"),a("code",[s._v("rz")]),s._v("选择"),a("code",[s._v("zip")]),s._v("包后，执行"),a("code",[s._v("unzip dist.zip")]),s._v("。")]),s._v(" "),a("li",[s._v("总结一下，我现在将项目部署到了前端服务器的"),a("code",[s._v("/data/web/demo/")]),s._v("目录下。")])]),s._v(" "),a("h3",{attrs:{id:"配置nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置nginx"}},[s._v("#")]),s._v(" 配置"),a("code",[s._v("nginx")])]),s._v(" "),a("ol",[a("li",[a("code",[s._v("Nginx")]),s._v("分为"),a("code",[s._v("master")]),s._v("与"),a("code",[s._v("server")]),s._v("两种。通常在"),a("code",[s._v("master")]),s._v("中维护公共配置，一般是在"),a("code",[s._v("/etc/ngnix/nginx.conf")]),s._v("文件中配置，而在"),a("code",[s._v("server")]),s._v("中则针对不同的项目来进行不同的配置,一般是在"),a("code",[s._v("/etc/nginx/conf.d/")]),s._v("目录中新建"),a("code",[s._v(".conf")]),s._v("后缀文件来进行配置。")]),s._v(" "),a("li",[s._v("以上述"),a("code",[s._v("demo")]),s._v("为例，新建"),a("code",[s._v("demo.conf")]),s._v("，配置"),a("code",[s._v("location")]),s._v("块。")])]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" 端口；\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" ip或者域名；\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("demo"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("web"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#不设置index的话 默认是index.html")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#index demo.html;")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("access_log")]),s._v(" logs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("demo_access"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("error_log")]),s._v(" logs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("demo_error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("上面配置的"),a("code",[s._v("Nginx")]),s._v("，当我们在浏览器中访问"),a("code",[s._v("网站/demo/test.html")]),s._v("时，就会映射到服务器的"),a("code",[s._v("/data/web/demo/test.html")]),s._v("。另外，"),a("code",[s._v("location")]),s._v("块这里有些比较重要的知识点。")])]),s._v(" "),a("h3",{attrs:{id:"location"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#location"}},[s._v("#")]),s._v(" "),a("code",[s._v("location")])]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" jsgoshu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("blog"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("web"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#alias /data/web/blog/nginx/;")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("access_log")]),s._v(" logs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("blog_nginx_access"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("error_log")]),s._v(" logs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("blog_nginx_error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("ol",[a("li",[s._v("路由匹配规则")])]),s._v(" "),a("p",[s._v("首先，一句话总结。匹配规则从高到低依次是"),a("strong",[s._v("精确匹配")]),s._v(">"),a("strong",[a("code",[s._v("^~")]),s._v("的字符串匹配")]),s._v(">"),a("strong",[s._v("正则匹配")]),s._v(">"),a("strong",[s._v("字符串匹配")]),s._v("。")]),s._v(" "),a("p",[s._v("匹配符号分为四类，分别是"),a("code",[s._v("=")]),s._v("、"),a("code",[s._v("~")]),s._v("、"),a("code",[s._v("~*")]),s._v("、"),a("code",[s._v("^~")]),s._v("。")]),s._v(" "),a("p",[a("code",[s._v("=")]),s._v("表示"),a("strong",[s._v("精确匹配")]),s._v("，优先级最高。")]),s._v(" "),a("p",[a("code",[s._v("^~")]),s._v("表示"),a("strong",[s._v("字符串匹配")]),s._v("，但优先级高于正则匹配")]),s._v(" "),a("p",[a("code",[s._v("~")]),s._v("与"),a("code",[s._v("~*")]),s._v("表示"),a("strong",[s._v("正则匹配")]),s._v("。")]),s._v(" "),a("p",[s._v("可能上面有点难以理解。"),a("code",[s._v("nginx")]),s._v("路由的一套完整匹配规则如下：")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("①.'='前缀的指令严格匹配这个查询。如果找到，停止搜索。")]),s._v(" "),a("p",[s._v("②.所有剩下的常规字符串，最长的匹配。如果这个匹配使用'^~'前缀，停止匹配。")]),s._v(" "),a("p",[s._v("③.正则表达式，按照在配置文件中定义的顺序。")]),s._v(" "),a("p",[s._v("④.如果第③条规则产生匹配的话，结果被使用。否则，使用第2条规则的结果。")])]),s._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[a("code",[s._v("root")]),s._v("与"),a("code",[s._v("alias")])])]),s._v(" "),a("p",[a("code",[s._v("root")]),s._v("会将访问时匹配的路由与该"),a("code",[s._v("root")]),s._v("值拼接在一起，形成服务器上完整路径。可以对照"),a("code",[s._v("node")]),s._v("中的"),a("code",[s._v("path.resolve(__dirname, '/blog/nginx/index.html')")]),s._v("来大致理解。")]),s._v(" "),a("p",[s._v("而"),a("code",[s._v("alias")]),s._v("意为"),a("strong",[s._v("别名")]),s._v("。它是将访问时匹配的路由映射到服务器的实际路径。不会再拼接一次。")]),s._v(" "),a("p",[s._v("另外我个人在使用"),a("code",[s._v("alias")]),s._v("时，发现需要注意一些问题：")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),a("p",[s._v("①"),a("code",[s._v("alias")]),s._v("只可以用来匹配目录，而不是静态资源。譬如访问路由是"),a("code",[s._v("/blog/nginx")]),s._v("，实际上会重定向到"),a("code",[s._v("/blog/nginx/")]),s._v("，这里的重定向会是301永久重定向。这种情况还好。但譬如访问"),a("code",[s._v("/test.jpg")]),s._v("，实际访问"),a("code",[s._v("/test.jpg/")]),s._v("。这就很严重了。")]),s._v(" "),a("p",[s._v("②301永久重定向会产生浏览器缓存，下次的请求会直接读取本地缓存，而不会发起网络请求。除非手动清除浏览器缓存并刷新。")]),s._v(" "),a("p",[s._v("③正是由于上面的原因，所以绝对不要用"),a("code",[s._v("alias")]),s._v("配置静态资源的映射访问。("),a("strong",[s._v("其实现实中也不会用一个静态资源对应一个nginx匹配")]),s._v(")。譬如：")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[s._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jpg "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alias")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("blog"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("当访问"),a("code",[s._v("域名/test.jpg")]),s._v("时，会产生301永久重定向到"),a("code",[s._v("域名/test.jpg/")]),s._v("。毫无疑问，页面上会出现"),a("code",[s._v("403")]),s._v("或者"),a("code",[s._v("404")]),s._v("。由于浏览器缓存，即使你换用"),a("code",[s._v("root")]),s._v("来重新配置"),a("code",[s._v("nginx")]),s._v("，"),a("strong",[s._v("只要原始访问路径不变")]),s._v("，都不会起到效果。设想下，如果这种情况发生在生产环境😫。")])]),s._v(" "),a("p",[s._v("总结：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("- `nginx`的匹配路由应该对应到目录，而不是某一静态资源。\n\n- 即使想要直接匹配静态资源，也不要用`alias`。而是可以用`root`。\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[a("code",[s._v("try_files")])])]),s._v(" "),a("p",[a("code",[s._v("try_files")]),s._v("的使用，多见于部署"),a("code",[s._v("SPA")]),s._v("项目。")]),s._v(" "),a("p",[s._v("语法："),a("code",[s._v("try_files $uri $uri/ index.html;")])]),s._v(" "),a("p",[a("code",[s._v("try_files")]),s._v("的作用是按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示文件夹），如果前述的文件或文件夹都找不到，会进行一个内部重定向到最后一个参数。")]),s._v(" "),a("p",[s._v("假设访问路径是"),a("code",[s._v("jsgoshu.cn/blog/nginx")]),s._v("。而"),a("code",[s._v("location")]),s._v("配置简略如下：")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("blog"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("web"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try_files")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("blog"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("依次寻找"),a("code",[s._v("/data/web/blog/nginx")]),s._v(" "),a("code",[s._v("data/web/blog/nginx/index.html")]),s._v("。都没有找到的话，就重定向到"),a("code",[s._v("/data/web/blog/index.html")]),s._v("。")]),s._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[a("code",[s._v("add_header")])])]),s._v(" "),a("p",[a("code",[s._v("add_header")]),s._v("可以用来设置响应头。常见的设置是这样："),a("code",[s._v("add_header Cache-Control no-store;")])]),s._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[a("code",[s._v("access_log")]),s._v("与"),a("code",[s._v("error_log")])])]),s._v(" "),a("p",[a("code",[s._v("access_log")]),s._v("与"),a("code",[s._v("error_log")]),s._v("分别代表的是访问日志与错误日志。这在开发中对于快速定位问题是非常有帮助的。所以推荐在配置"),a("code",[s._v("location")]),s._v("的时候也一定加上"),a("code",[s._v("log")]),s._v("。")]),s._v(" "),a("p",[s._v("另外要注意的是，在"),a("code",[s._v("conf.d")]),s._v("目录中自定义的的"),a("code",[s._v("conf")]),s._v("文件，都会以"),a("code",[s._v("include")]),s._v("引入到"),a("code",[s._v("nginx.conf")]),s._v("中。所以在设置"),a("code",[s._v("access_log")]),s._v("与"),a("code",[s._v("error_log")]),s._v("的"),a("strong",[s._v("相对路径")]),s._v("时，实际上是要以"),a("code",[s._v("nginx.conf")]),s._v("的相对路径来设置。")])])}),[],!1,null,null,null);t.default=n.exports}}]);