(window.webpackJsonp=window.webpackJsonp||[]).push([[134],{593:function(t,s,n){"use strict";n.r(s);var e=n(40),a=Object(e.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h2",{attrs:{id:"_1-相关链接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-相关链接"}},[t._v("#")]),t._v(" 1.相关链接")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信开发者文档"),n("OutboundLink")],1)]),t._v(" "),n("p",[n("a",{attrs:{href:"http://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信测试公众号"),n("OutboundLink")],1)]),t._v(" "),n("h2",{attrs:{id:"_2-介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-介绍"}},[t._v("#")]),t._v(" 2.介绍")]),t._v(" "),n("p",[t._v("最近公司要开发一个"),n("code",[t._v("H5")]),t._v("项目，该项目的一部分功能是要将用户引流至公众号，引导用户关注公众号。那么就需要判断该用户是否已关注公众号。")]),t._v(" "),n("p",[t._v("而在微信的角度，每一个用户都有一个唯一标识"),n("code",[t._v("openId")]),t._v("。通过这个"),n("code",[t._v("openId")]),t._v("我们就能获取到很多其他相关信息。大致流程如下：")]),t._v(" "),n("ol",[n("li",[t._v("网页授权(静默授权、有感授权)。获取到"),n("code",[t._v("code")]),t._v("。")]),t._v(" "),n("li",[t._v("将"),n("code",[t._v("code")]),t._v("传递给后端，后端调用微信服务器接口，获取"),n("code",[t._v("openId")]),t._v("。后端获取到"),n("code",[t._v("openId")]),t._v("后，再调用微信其他接口，确定该"),n("code",[t._v("openId")]),t._v("的用户是否关注了公众号。如果关注了公众号，就正常走业务流程。否则就进行第"),n("code",[t._v("3")]),t._v("步。")]),t._v(" "),n("li",[t._v("前端接收到用户没有关注公众号的结果后，将页面重定向到具有"),n("strong",[t._v("公众号二维码")]),t._v("的页面，供用户识别关注。")]),t._v(" "),n("li",[t._v("用户关注时，后端识别到该"),n("code",[t._v("openId")]),t._v("，自动在公众号推送一条模板信息，供用户点击，回到业务页面。形成闭环。")])]),t._v(" "),n("p",[t._v("接下来，我们就来了解下第一步的主要实现。")]),t._v(" "),n("h2",{attrs:{id:"_3-授权登录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-授权登录"}},[t._v("#")]),t._v(" 3.授权登录")]),t._v(" "),n("p",[t._v("这一部分，微信文档其实已经介绍的比较详细。总结下：")]),t._v(" "),n("p",[n("strong",[t._v("授权登录")]),t._v("分为两种："),n("strong",[t._v("静默授权")]),t._v("(获取用户基本信息接口，需要用户关注公众号才能调用)与"),n("strong",[t._v("有感授权")]),t._v("(需要用户手动点确认授权，无须关注，就可在授权后获取该用户的基本信息。相比静默授权，除了"),n("code",[t._v("openId")]),t._v("外还能获取用户更多的信息，譬如昵称、头像等)。")]),t._v(" "),n("h3",{attrs:{id:"_3-1-静默授权"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-静默授权"}},[t._v("#")]),t._v(" 3-1.静默授权")]),t._v(" "),n("p",[n("code",[t._v("scope")]),t._v("为"),n("code",[t._v("snsapi_base")]),t._v(":")]),t._v(" "),n("blockquote",[n("p",[t._v("https://open.weixin.qq.com/connect/oauth2/authorize?\nappid=wx520c15f417810387\n&redirect_uri=https%3A%2F%2Fchong.qq.com%2Fphp%2Findex.html\n&response_type=code\n&scope=snsapi_base\n&state=123\n#wechat_redirect")])]),t._v(" "),n("p",[t._v("具体参数含义可见微信文档。另外要注意几点：")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("appid")]),t._v(": 微信公众号的"),n("code",[t._v("ID")]),t._v("。")]),t._v(" "),n("li",[n("code",[t._v("redirect_uri")]),t._v(": 授权成功后的重定向链接。该链接需要在公众号后台进行配置，路径为“开发 - 接口权限 - 网页服务 - 网页帐号 - 网页授权获取用户基本信息”。请注意，这里填写的是"),n("strong",[t._v("域名")]),t._v("（是一个字符串），而不是"),n("code",[t._v("URL")]),t._v("，因此请勿加 "),n("code",[t._v("http://")]),t._v(" 等协议头。")]),t._v(" "),n("li",[t._v("授权回调域名配置规范为全域名，比如需要网页授权的域名为："),n("code",[t._v("www.qq.com")]),t._v("，配置以后此域名下面的页面"),n("code",[t._v("http://www.qq.com/music.html")]),t._v(" 、 "),n("code",[t._v("http://www.qq.com/login.html")]),t._v(" 都可以进行"),n("code",[t._v("OAuth2.0")]),t._v("鉴权。但"),n("code",[t._v("http://pay.qq.com")]),t._v(" 、 "),n("code",[t._v("http://music.qq.com")]),t._v(" 、 "),n("code",[t._v("http://qq.com")]),t._v(" 无法进行"),n("code",[t._v("OAuth2.0")]),t._v("鉴权。")]),t._v(" "),n("li",[t._v("另外，"),n("code",[t._v("redirect_uri")]),t._v("需要使用"),n("code",[t._v("encodeURIComponent")]),t._v("转码一下。可以使用下面这个函数：")])]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("urlEncode")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("str")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  str "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("str "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("toString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("encodeURIComponent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("str"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/!/g")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%21'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/'/g")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%27'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/\\(/g")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%28'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/\\)/g")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%29'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/\\*/g")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%2A'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/%20/g")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'+'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("h3",{attrs:{id:"_3-2-有感授权"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-有感授权"}},[t._v("#")]),t._v(" 3-2.有感授权")]),t._v(" "),n("p",[n("code",[t._v("scope")]),t._v("为"),n("code",[t._v("snsapi_userinfo")]),t._v(":")]),t._v(" "),n("blockquote",[n("p",[t._v("https://open.weixin.qq.com/connect/oauth2/authorize?\nappid=wxf0e81c3bee622d60\n&redirect_uri=http%3A%2F%2Fnba.bluewebgame.com%2Foauth_response.php\n&response_type=code\n&scope=snsapi_userinfo\n&state=STATE\n#wechat_redirect")])]),t._v(" "),n("h2",{attrs:{id:"_4-申请测试公众号"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-申请测试公众号"}},[t._v("#")]),t._v(" 4.申请测试公众号")]),t._v(" "),n("p",[t._v("可能已经注意到了，上述的"),n("code",[t._v("redirect_uri")]),t._v("需要在公众号后台配置受信任的备案域名。在实际开发过程中，一般我们的地址都是"),n("code",[t._v("IP")]),t._v("。")]),t._v(" "),n("p",[t._v("所以我们可以在开发环境使用测试公众号，实际生产中，再将"),n("code",[t._v("appId")]),t._v("与域名替换成生产的。")]),t._v(" "),n("p",[t._v("访问"),n("a",{attrs:{href:"http://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信测试公众号"),n("OutboundLink")],1),t._v("。扫码关注后，你就有了一个测试账号。该测试公众号允许配置"),n("strong",[t._v("重定向链接")]),t._v("为"),n("code",[t._v("IP")]),t._v("形式。")]),t._v(" "),n("p",[t._v("“网页服务-网页帐号-网页授权获取用户基本信息”：")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://raw.githubusercontent.com/oneyoung19/vuepress-blog-img/main/img/0081Kckwly1gm006rxczxj317p0u0wnb.jpg",alt:""}})]),t._v(" "),n("p",[t._v("添加重定向"),n("code",[t._v("IP")]),t._v(":")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://raw.githubusercontent.com/oneyoung19/vuepress-blog-img/main/img/0081Kckwly1gm0084r1fnj314c0t2jtw.jpg",alt:""}})]),t._v(" "),n("h2",{attrs:{id:"_5-微信开发者工具"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-微信开发者工具"}},[t._v("#")]),t._v(" 5.微信开发者工具")]),t._v(" "),n("p",[t._v("如果在浏览器端调试"),n("strong",[t._v("公众号")]),t._v("，即使将浏览器设置成"),n("strong",[t._v("微信浏览器")]),t._v("，也会发现授权登录的操作不能正常进行，不会发生成功的重定向。")]),t._v(" "),n("p",[t._v("所以我们推荐在"),n("strong",[t._v("微信开发者工具")]),t._v("下进行调试"),n("code",[t._v("H5")]),t._v("页面。")]),t._v(" "),n("p",[t._v("只需要将开发模式修改为"),n("strong",[t._v("公众号网页模式")]),t._v("。")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://raw.githubusercontent.com/oneyoung19/vuepress-blog-img/main/img/0081Kckwly1gm00bigs7tj30mu0beti6.jpg",alt:""}})])])}),[],!1,null,null,null);s.default=a.exports}}]);