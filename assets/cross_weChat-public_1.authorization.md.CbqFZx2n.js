import{_ as s,o as a,c as e,aP as t}from"./chunks/framework.D1yHhm2y.js";const c=JSON.parse('{"title":"微信公众号H5授权","description":"","frontmatter":{"title":"微信公众号H5授权"},"headers":[],"relativePath":"cross/weChat-public/1.authorization.md","filePath":"cross/weChat-public/1.authorization.md","lastUpdated":1735964775000}'),h={name:"cross/weChat-public/1.authorization.md"};function n(p,i,o,l,r,k){return a(),e("div",null,i[0]||(i[0]=[t(`<h2 id="_1-相关链接" tabindex="-1">1.相关链接 <a class="header-anchor" href="#_1-相关链接" aria-label="Permalink to &quot;1.相关链接&quot;">​</a></h2><p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html" target="_blank" rel="noreferrer">微信开发者文档</a></p><p><a href="http://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&amp;t=sandbox/index" target="_blank" rel="noreferrer">微信测试公众号</a></p><h2 id="_2-介绍" tabindex="-1">2.介绍 <a class="header-anchor" href="#_2-介绍" aria-label="Permalink to &quot;2.介绍&quot;">​</a></h2><p>最近公司要开发一个<code>H5</code>项目，该项目的一部分功能是要将用户引流至公众号，引导用户关注公众号。那么就需要判断该用户是否已关注公众号。</p><p>而在微信的角度，每一个用户都有一个唯一标识<code>openId</code>。通过这个<code>openId</code>我们就能获取到很多其他相关信息。大致流程如下：</p><ol><li>网页授权(静默授权、有感授权)。获取到<code>code</code>。</li><li>将<code>code</code>传递给后端，后端调用微信服务器接口，获取<code>openId</code>。后端获取到<code>openId</code>后，再调用微信其他接口，确定该<code>openId</code>的用户是否关注了公众号。如果关注了公众号，就正常走业务流程。否则就进行第<code>3</code>步。</li><li>前端接收到用户没有关注公众号的结果后，将页面重定向到具有<strong>公众号二维码</strong>的页面，供用户识别关注。</li><li>用户关注时，后端识别到该<code>openId</code>，自动在公众号推送一条模板信息，供用户点击，回到业务页面。形成闭环。</li></ol><p>接下来，我们就来了解下第一步的主要实现。</p><h2 id="_3-授权登录" tabindex="-1">3.授权登录 <a class="header-anchor" href="#_3-授权登录" aria-label="Permalink to &quot;3.授权登录&quot;">​</a></h2><p>这一部分，微信文档其实已经介绍的比较详细。总结下：</p><p><strong>授权登录</strong>分为两种：<strong>静默授权</strong>(获取用户基本信息接口，需要用户关注公众号才能调用)与<strong>有感授权</strong>(需要用户手动点确认授权，无须关注，就可在授权后获取该用户的基本信息。相比静默授权，除了<code>openId</code>外还能获取用户更多的信息，譬如昵称、头像等)。</p><h3 id="_3-1-静默授权" tabindex="-1">3-1.静默授权 <a class="header-anchor" href="#_3-1-静默授权" aria-label="Permalink to &quot;3-1.静默授权&quot;">​</a></h3><p><code>scope</code>为<code>snsapi_base</code>:</p><blockquote><p><a href="https://open.weixin.qq.com/connect/oauth2/authorize" target="_blank" rel="noreferrer">https://open.weixin.qq.com/connect/oauth2/authorize</a>? appid=wx520c15f417810387 &amp;redirect_uri=https%3A%2F%2Fchong.qq.com%2Fphp%2Findex.html &amp;response_type=code &amp;scope=snsapi_base &amp;state=123 #wechat_redirect</p></blockquote><p>具体参数含义可见微信文档。另外要注意几点：</p><ul><li><code>appid</code>: 微信公众号的<code>ID</code>。</li><li><code>redirect_uri</code>: 授权成功后的重定向链接。该链接需要在公众号后台进行配置，路径为“开发 - 接口权限 - 网页服务 - 网页帐号 - 网页授权获取用户基本信息”。请注意，这里填写的是<strong>域名</strong>（是一个字符串），而不是<code>URL</code>，因此请勿加 <code>http://</code> 等协议头。</li><li>授权回调域名配置规范为全域名，比如需要网页授权的域名为：<code>www.qq.com</code>，配置以后此域名下面的页面<code>http://www.qq.com/music.html</code> 、 <code>http://www.qq.com/login.html</code> 都可以进行<code>OAuth2.0</code>鉴权。但<code>http://pay.qq.com</code> 、 <code>http://music.qq.com</code> 、 <code>http://qq.com</code> 无法进行<code>OAuth2.0</code>鉴权。</li><li>另外，<code>redirect_uri</code>需要使用<code>encodeURIComponent</code>转码一下。可以使用下面这个函数：</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> urlEncode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  str </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (str </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encodeURIComponent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(str).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">!</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">g</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%21&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">g</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%27&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold;">\\(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">g</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%28&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold;">\\)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">g</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%29&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#22863A;--shiki-light-font-weight:bold;--shiki-dark:#85E89D;--shiki-dark-font-weight:bold;">\\*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">g</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%2A&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">%20</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">g</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;+&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3-2-有感授权" tabindex="-1">3-2.有感授权 <a class="header-anchor" href="#_3-2-有感授权" aria-label="Permalink to &quot;3-2.有感授权&quot;">​</a></h3><p><code>scope</code>为<code>snsapi_userinfo</code>:</p><blockquote><p><a href="https://open.weixin.qq.com/connect/oauth2/authorize" target="_blank" rel="noreferrer">https://open.weixin.qq.com/connect/oauth2/authorize</a>? appid=wxf0e81c3bee622d60 &amp;redirect_uri=http%3A%2F%2Fnba.bluewebgame.com%2Foauth_response.php &amp;response_type=code &amp;scope=snsapi_userinfo &amp;state=STATE #wechat_redirect</p></blockquote><h2 id="_4-申请测试公众号" tabindex="-1">4.申请测试公众号 <a class="header-anchor" href="#_4-申请测试公众号" aria-label="Permalink to &quot;4.申请测试公众号&quot;">​</a></h2><p>可能已经注意到了，上述的<code>redirect_uri</code>需要在公众号后台配置受信任的备案域名。在实际开发过程中，一般我们的地址都是<code>IP</code>。</p><p>所以我们可以在开发环境使用测试公众号，实际生产中，再将<code>appId</code>与域名替换成生产的。</p><p>访问<a href="http://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&amp;t=sandbox/index" target="_blank" rel="noreferrer">微信测试公众号</a>。扫码关注后，你就有了一个测试账号。该测试公众号允许配置<strong>重定向链接</strong>为<code>IP</code>形式。</p><p>“网页服务-网页帐号-网页授权获取用户基本信息”：</p><p><img src="https://raw.githubusercontent.com/oneyoung19/vuepress-blog-img/main/img/0081Kckwly1gm006rxczxj317p0u0wnb.jpg" alt=""></p><p>添加重定向<code>IP</code>:</p><p><img src="https://raw.githubusercontent.com/oneyoung19/vuepress-blog-img/main/img/0081Kckwly1gm0084r1fnj314c0t2jtw.jpg" alt=""></p><h2 id="_5-微信开发者工具" tabindex="-1">5.微信开发者工具 <a class="header-anchor" href="#_5-微信开发者工具" aria-label="Permalink to &quot;5.微信开发者工具&quot;">​</a></h2><p>如果在浏览器端调试<strong>公众号</strong>，即使将浏览器设置成<strong>微信浏览器</strong>，也会发现授权登录的操作不能正常进行，不会发生成功的重定向。</p><p>所以我们推荐在<strong>微信开发者工具</strong>下进行调试<code>H5</code>页面。</p><p>只需要将开发模式修改为<strong>公众号网页模式</strong>。</p><p><img src="https://raw.githubusercontent.com/oneyoung19/vuepress-blog-img/main/img/0081Kckwly1gm00bigs7tj30mu0beti6.jpg" alt=""></p>`,33)]))}const g=s(h,[["render",n]]);export{c as __pageData,g as default};
