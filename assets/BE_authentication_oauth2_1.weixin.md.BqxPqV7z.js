import{_ as i,c as a,o as t,b0 as e}from"./chunks/framework.CEggy_nf.js";const r=JSON.parse('{"title":"微信授权","description":"","frontmatter":{"title":"微信授权"},"headers":[],"relativePath":"BE/authentication/oauth2/1.weixin.md","filePath":"BE/authentication/oauth2/1.weixin.md","lastUpdated":1745063360000}'),n={name:"BE/authentication/oauth2/1.weixin.md"};function d(p,s,h,o,l,c){return t(),a("div",null,s[0]||(s[0]=[e(`<p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html" target="_blank" rel="noreferrer">微信授权</a>利用了 <code>OAuth2.0</code> 机制的<strong>授权码模式</strong>。</p><p>整体流程如下：</p><h2 id="_1-获取授权码code" tabindex="-1">1.获取授权码code <a class="header-anchor" href="#_1-获取授权码code" aria-label="Permalink to &quot;1.获取授权码code&quot;">​</a></h2><p>为了获取到授权码 <code>code</code>，首先跳转到微信官方提供的 <code>URL</code>：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`https://open.weixin.qq.com/connect/oauth2/authorize</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ?appid=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APPID</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &amp;redirect_uri=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">REDIRECT_URI</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &amp;response_type=code</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &amp;scope=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SCOPE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &amp;state=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">STATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  #wechat_redirect\`</span></span></code></pre></div><p>其中，各个参数含义如下：</p><table tabindex="0"><thead><tr><th>参数</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td><code>appid</code></td><td>是</td><td>公众号的唯一标识</td></tr><tr><td><code>redirect_uri</code></td><td>是</td><td>授权后重定向的回调链接地址， 请使用 <code>urlEncode</code> 对链接进行处理</td></tr><tr><td><code>response_type</code></td><td>是</td><td>返回类型，固定值 <code>code</code>，表示<strong>授权码</strong>模式。</td></tr><tr><td><code>scope</code></td><td>是</td><td>应用授权作用域，<code>snsapi_base</code> （不弹出授权页面，直接跳转，只能获取用户<code>openid</code>），<code>snsapi_userinfo</code> （弹出授权页面，可通过<code>openid</code>拿到昵称、性别、所在地。并且， 即使在未关注的情况下，只要用户授权，也能获取其信息 ）</td></tr><tr><td><code>state</code></td><td>否</td><td>重定向后会带上 <code>state</code>参数，开发者可以填写 <code>a-zA-Z0-9</code> 的参数值，最多 <code>128</code> 字节</td></tr><tr><td><code>#wechat_redirect</code></td><td>是</td><td>无论直接打开还是做页面 <code>302</code> 重定向时候，必须带此参数</td></tr></tbody></table><p>当上述链接授权通过之后，系统将会重定向至：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`redirect_uri/?code=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CODE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&amp;state=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">STATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><code>code</code> 作为换取 <code>access_token</code> 的票据，具有以下特点：</p><ol><li>每次用户授权带上的 <code>code</code> 将不一样；</li><li><code>code</code> 只能使用一次；</li><li><code>5</code> 分钟未被使用自动过期。</li></ol></div><h2 id="_2-根据code获取access-token" tabindex="-1">2.根据code获取access_token <a class="header-anchor" href="#_2-根据code获取access-token" aria-label="Permalink to &quot;2.根据code获取access_token&quot;">​</a></h2><p>在获取到 <code>code</code> 之后，我们可以用 <code>code</code> 向以下链接交换 <code>access_token</code>（这一步在服务端进行）。</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`https://api.weixin.qq.com/sns/oauth2/access_token</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ?appid=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APPID</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &amp;secret=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SECRET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &amp;code=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CODE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &amp;grant_type=authorization_code\`</span></span></code></pre></div><p>其中参数含义如下：</p><table tabindex="0"><thead><tr><th>参数</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td><code>appid</code></td><td>是</td><td>公众号的唯一标识</td></tr><tr><td><code>secret</code></td><td>是</td><td>公众号的 <code>appsecret</code></td></tr><tr><td><code>code</code></td><td>是</td><td>填写第一步获取的 <code>code</code> 参数</td></tr><tr><td><code>grant_type</code></td><td>是</td><td>固定值 <code>authorization_code</code>,表示<strong>授权码</strong>模式。</td></tr></tbody></table><p>当接口正确响应时，大致有以下数据结构：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;access_token&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ACCESS_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;expires_in&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;refresh_token&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;REFRESH_TOKEN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;openid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;OPENID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;scope&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SCOPE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;is_snapshotuser&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;unionid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UNIONID&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="_3-拉取用户信息-需scope为-snsapi-userinfo" tabindex="-1">3.拉取用户信息(需scope为 snsapi_userinfo) <a class="header-anchor" href="#_3-拉取用户信息-需scope为-snsapi-userinfo" aria-label="Permalink to &quot;3.拉取用户信息(需scope为 snsapi_userinfo)&quot;">​</a></h2><p>如果 <code>scope</code> 为 <code>snsapi_base</code>，那么该模式在上述第二步已经结束。</p><p>当 <code>scope</code> 为 <code>snsapi_userinfo</code>，则可以参考此节拉取用户信息。</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`https://api.weixin.qq.com/sns/userinfo</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ?access_token=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ACCESS_TOKEN</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &amp;openid=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">OPENID</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &amp;lang=zh_CN\`</span></span></code></pre></div><p>参数含义如下：</p><table tabindex="0"><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td><code>access_token</code></td><td>网页授权接口调用凭证</td></tr><tr><td><code>openid</code></td><td>用户的唯一标识</td></tr><tr><td><code>lang</code></td><td>返回国家地区语言版本，<code>zh_CN</code> 简体，<code>zh_TW</code> 繁体，<code>en</code> 英语</td></tr></tbody></table><h2 id="_4-刷新access-token-如果需要" tabindex="-1">4.刷新access_token（如果需要） <a class="header-anchor" href="#_4-刷新access-token-如果需要" aria-label="Permalink to &quot;4.刷新access_token（如果需要）&quot;">​</a></h2><p>在第二步中，我们能同时获取到 <code>access_token</code> 和 <code>refresh_token</code>。</p><p>由于 <code>access_token</code> 存在一定的有效期，因此当它过期时（一般为 <code>7200s</code>），我们可以借助 <code>refresh_token</code> 调用以下链接从而刷新 <code>access_token</code>：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`https://api.weixin.qq.com/sns/oauth2/refresh_token</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ?appid=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APPID</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &amp;grant_type=refresh_token</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &amp;refresh_token=\${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">REFRESH_TOKEN</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span></span></code></pre></div>`,27)]))}const F=i(n,[["render",d]]);export{r as __pageData,F as default};
